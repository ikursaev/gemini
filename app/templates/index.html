<!DOCTYPE html>
<html lang="en" class="">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document Extractor</title>
    <link href="/static/output.css" rel="stylesheet" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;500;600;700&family=JetBrains+Mono:wght@300;400;500;600&display=swap"
      rel="stylesheet"
    />
    <style>
      /* Fix scrollbar jumping by always showing scrollbar */
      html {
        overflow-y: scroll;
        scrollbar-gutter: stable;
      }

      /* Ensure full dark mode coverage */
      html,
      body {
        background-color: inherit;
        color: inherit;
        transition: background-color 0.3s ease, color 0.3s ease;
      }

      /* Ensure body doesn't shift when dropdown opens */
      body {
        margin-right: calc(-1 * (100vw - 100%));
        padding-right: calc(100vw - 100%);
        overflow-x: hidden;
      }

      /* Prevent layout shifts from dropdown */
      .dropdown-container {
        position: relative;
        isolation: isolate;
      }

      #tasks-dropdown {
        position: fixed;
        top: 0;
        right: 0;
        margin-top: 0;
        width: 22rem;
        z-index: 9999;
        transform: translateY(0);
        transition: all 0.3s ease;
        will-change: transform, opacity;
      }

      /* Global box-sizing */
      *,
      *::before,
      *::after {
        box-sizing: border-box;
      }

      /* Modern font application */
      * {
        font-family: "Space Grotesk", -apple-system, BlinkMacSystemFont,
          "Segoe UI", sans-serif;
      }

      /* Headings use Space Grotesk with enhanced styling */
      h1,
      h2,
      h3,
      h4,
      h5,
      h6 {
        font-family: "Space Grotesk", -apple-system, BlinkMacSystemFont,
          "Segoe UI", sans-serif;
        font-weight: 600;
        letter-spacing: -0.025em;
      }

      /* Title gets extra styling */
      h1 {
        font-weight: 700;
        letter-spacing: -0.05em;
      }

      /* Buttons get the modern font */
      button,
      .button {
        font-family: "Space Grotesk", -apple-system, BlinkMacSystemFont,
          "Segoe UI", sans-serif;
        font-weight: 500;
        letter-spacing: -0.025em;
      }

      /* Enhanced typography for drag and drop area */
      .drop-area {
        font-family: "Space Grotesk", -apple-system, BlinkMacSystemFont,
          "Segoe UI", sans-serif;
      }

      .drop-area p {
        font-family: "Space Grotesk", -apple-system, BlinkMacSystemFont,
          "Segoe UI", sans-serif;
      }

      /* Task display gets modern font */
      .tasks-dropdown,
      .task-item {
        font-family: "Space Grotesk", -apple-system, BlinkMacSystemFont,
          "Segoe UI", sans-serif;
      }

      /* Form elements get modern font */
      input,
      select,
      textarea {
        font-family: "Space Grotesk", -apple-system, BlinkMacSystemFont,
          "Segoe UI", sans-serif;
      }

      /* Badge text gets modern font */
      .badge,
      .status-badge {
        font-family: "Space Grotesk", -apple-system, BlinkMacSystemFont,
          "Segoe UI", sans-serif;
        font-weight: 500;
      }

      /* Body text gets improved styling */
      p,
      span,
      div {
        font-family: "Space Grotesk", -apple-system, BlinkMacSystemFont,
          "Segoe UI", sans-serif;
        letter-spacing: -0.01em;
      }

      /* Monospace elements use JetBrains Mono */
      code,
      pre,
      .monospace {
        font-family: "JetBrains Mono", "Consolas", "Monaco", monospace;
      }

      /* Additional dark mode coverage */
      .dark {
        color-scheme: dark;
      }

      /* Ensure all elements inherit dark mode properly */
      .dark * {
        border-color: inherit;
      }

      /* Force dark mode on html element */
      html.dark {
        background: #111827;
        color: #f9fafb;
      }

      /* Ensure body inherits from html in dark mode */
      html.dark body {
        background: inherit;
        color: inherit;
      }

      /* Dark mode for any missed elements */
      .dark h1,
      .dark h2,
      .dark h3,
      .dark h4,
      .dark h5,
      .dark h6 {
        color: #f9fafb;
      }

      .dark p,
      .dark span,
      .dark div {
        color: inherit;
      }

      /* Scrollbar styling for dark mode */
      .dark ::-webkit-scrollbar {
        width: 8px;
        background: #1f2937;
      }

      .dark ::-webkit-scrollbar-thumb {
        background: #4b5563;
        border-radius: 4px;
      }

      .dark ::-webkit-scrollbar-thumb:hover {
        background: #6b7280;
      }

      .glass {
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.2);
      }
      .dark .glass {
        background: rgba(17, 24, 39, 0.8);
        border: 1px solid rgba(55, 65, 81, 0.3);
      }

      /* Enhanced dark mode for all glass elements */
      .dark .glass {
        background: rgba(17, 24, 39, 0.85);
        border: 1px solid rgba(75, 85, 99, 0.4);
        backdrop-filter: blur(16px);
      }

      /* Ensure full dark mode coverage for all elements */
      .dark * {
        border-color: rgba(75, 85, 99, 0.3);
      }

      .dark *:not(.tasks-button):not(.upload-button):not(.theme-toggle-button) {
        background-color: inherit;
        color: inherit;
      }

      /* Override any remaining light backgrounds in dark mode */
      .dark .bg-white {
        background-color: rgba(31, 41, 55, 0.8) !important;
      }

      .dark .bg-gray-50 {
        background-color: rgba(17, 24, 39, 0.8) !important;
      }

      .dark .bg-slate-50 {
        background-color: rgba(15, 23, 42, 0.8) !important;
      }

      /* Ensure proper text colors in dark mode */
      .dark .text-gray-900 {
        color: #f3f4f6 !important;
      }

      .dark .text-gray-800 {
        color: #e5e7eb !important;
      }

      .dark .text-gray-700 {
        color: #d1d5db !important;
      }

      .dark .text-gray-600 {
        color: #9ca3af !important;
      }

      /* Enhanced dropdown styling for dark mode */
      .dark #tasks-dropdown {
        background: rgba(17, 24, 39, 0.95);
        border: 1px solid rgba(75, 85, 99, 0.5);
        backdrop-filter: blur(20px);
      }

      /* Enhanced task list items for dark mode */
      .dark .task-item {
        border-color: rgba(75, 85, 99, 0.3);
        color: #f3f4f6;
      }

      .dark .task-item:hover {
        background-color: rgba(55, 65, 81, 0.2);
      }

      /* Dark mode for form elements */
      .dark input,
      .dark textarea,
      .dark select {
        background-color: rgba(55, 65, 81, 0.8);
        border-color: rgba(75, 85, 99, 0.6);
        color: #f3f4f6;
      }

      .dark input:focus,
      .dark textarea:focus,
      .dark select:focus {
        border-color: rgba(147, 51, 234, 0.6);
        box-shadow: 0 0 0 3px rgba(147, 51, 234, 0.1);
      }

      /* Dark mode scrollbar styling - Apply to all elements */
      ::-webkit-scrollbar {
        width: 8px;
      }

      ::-webkit-scrollbar-track {
        background: rgba(0, 0, 0, 0.1);
      }

      ::-webkit-scrollbar-thumb {
        background: rgba(0, 0, 0, 0.3);
        border-radius: 4px;
      }

      ::-webkit-scrollbar-thumb:hover {
        background: rgba(0, 0, 0, 0.5);
      }

      .dark ::-webkit-scrollbar-track {
        background: rgba(31, 41, 55, 0.5);
      }

      .dark ::-webkit-scrollbar-thumb {
        background: rgba(107, 114, 128, 0.6);
        border-radius: 4px;
      }

      .dark ::-webkit-scrollbar-thumb:hover {
        background: rgba(156, 163, 175, 0.8);
      }
      .icon-container {
        overflow: hidden;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
      }
      svg {
        max-width: 100%;
        max-height: 100%;
        flex-shrink: 0;
      }

      /* Enhanced button styles - Modern pill-shaped blue button */
      .tasks-button {
        background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
        border: none;
        color: white;
        border-radius: 9999px; /* Full pill shape */
        padding: 0.75rem 1.5rem;
        font-weight: 600;
        font-size: 0.875rem;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        box-shadow: 0 4px 14px 0 rgba(59, 130, 246, 0.25);
        position: relative;
        overflow: hidden;
      }

      .tasks-button:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px 0 rgba(59, 130, 246, 0.35);
        background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
      }

      .tasks-button:active {
        transform: translateY(-1px);
        box-shadow: 0 4px 14px 0 rgba(59, 130, 246, 0.25);
      }

      .tasks-button:focus {
        outline: none;
        box-shadow: 0 4px 14px 0 rgba(59, 130, 246, 0.25),
          0 0 0 2px rgba(147, 197, 253, 0.5);
      }

      /* Dark mode adjustments */
      .dark .tasks-button {
        background: linear-gradient(135deg, #1e40af 0%, #1e3a8a 100%);
        box-shadow: 0 4px 14px 0 rgba(30, 64, 175, 0.3);
      }

      .dark .tasks-button:hover {
        background: linear-gradient(135deg, #1e3a8a 0%, #1e3a8a 100%);
        box-shadow: 0 8px 25px 0 rgba(30, 64, 175, 0.4);
      }

      /* Enhanced theme toggle button - Round and modern */
      .theme-toggle-button {
        width: 2.5rem;
        height: 2.5rem;
        border-radius: 9999px;
        background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
        border: 1px solid rgba(226, 232, 240, 0.8);
        color: #4b5563;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.07);
        cursor: pointer;
      }

      .theme-toggle-button:hover {
        background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%);
        border-color: rgba(148, 163, 184, 0.8);
        color: #1f2937;
        transform: translateY(-1px);
        box-shadow: 0 8px 16px rgba(0, 0, 0, 0.12);
      }

      .dark .theme-toggle-button {
        background: linear-gradient(135deg, #374151 0%, #1f2937 100%);
        border-color: rgba(75, 85, 99, 0.8);
        color: #d1d5db;
      }

      .dark .theme-toggle-button:hover {
        background: linear-gradient(135deg, #4b5563 0%, #374151 100%);
        border-color: rgba(107, 114, 128, 0.8);
        color: #f3f4f6;
      }

      /* Upload button - Pill-shaped to match design system */
      .upload-button {
        background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
        border: none;
        color: white;
        border-radius: 9999px;
        padding: 0.75rem 1.5rem;
        font-weight: 600;
        font-size: 0.875rem;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        box-shadow: 0 4px 14px 0 rgba(139, 92, 246, 0.25);
        width: 100%;
      }

      .upload-button:hover:not(:disabled) {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px 0 rgba(139, 92, 246, 0.35);
        background: linear-gradient(135deg, #7c3aed 0%, #6d28d9 100%);
      }

      .upload-button:active:not(:disabled) {
        transform: translateY(-1px);
        box-shadow: 0 4px 14px 0 rgba(139, 92, 246, 0.25);
      }

      .upload-button:disabled {
        opacity: 0.75;
        cursor: not-allowed;
        transform: none;
      }

      /* Enhanced drop area styling */
      .drop-area {
        background: linear-gradient(
          135deg,
          rgba(255, 255, 255, 0.8) 0%,
          rgba(248, 250, 252, 0.8) 100%
        );
        backdrop-filter: blur(10px);
        border: 2px dashed rgba(203, 213, 225, 0.8);
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      }

      .drop-area:hover {
        border-color: rgba(147, 51, 234, 0.6);
        background: linear-gradient(
          135deg,
          rgba(245, 243, 255, 0.9) 0%,
          rgba(237, 233, 254, 0.9) 100%
        );
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(147, 51, 234, 0.15);
      }

      .drop-area.drag-over {
        border-color: rgba(147, 51, 234, 0.8);
        background: linear-gradient(
          135deg,
          rgba(245, 243, 255, 1) 0%,
          rgba(237, 233, 254, 1) 100%
        );
        transform: scale(1.02);
        box-shadow: 0 8px 20px rgba(147, 51, 234, 0.25);
      }

      .dark .drop-area {
        background: linear-gradient(
          135deg,
          rgba(31, 41, 55, 0.8) 0%,
          rgba(17, 24, 39, 0.8) 100%
        );
        border-color: rgba(75, 85, 99, 0.8);
      }

      .dark .drop-area:hover {
        border-color: rgba(147, 51, 234, 0.6);
        background: linear-gradient(
          135deg,
          rgba(49, 46, 129, 0.2) 0%,
          rgba(67, 56, 202, 0.2) 100%
        );
      }

      .dark .drop-area.drag-over {
        border-color: rgba(147, 51, 234, 0.8);
        background: linear-gradient(
          135deg,
          rgba(49, 46, 129, 0.3) 0%,
          rgba(67, 56, 202, 0.3) 100%
        );
      }

      /* Enhanced badge animations with vibrant colors */
      .badge-enter {
        animation: badge-slide-in 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
      }

      @keyframes badge-slide-in {
        from {
          opacity: 0;
          transform: translateX(15px) scale(0.6);
        }
        to {
          opacity: 1;
          transform: translateX(0) scale(1);
        }
      }

      .badge-pulse {
        animation: badge-pulse 2s ease-in-out infinite;
      }

      @keyframes badge-pulse {
        0%,
        100% {
          opacity: 1;
          transform: scale(1);
          box-shadow: 0 0 0 0 rgba(245, 158, 11, 0.7);
        }
        50% {
          opacity: 0.9;
          transform: scale(1.05);
          box-shadow: 0 0 0 4px rgba(245, 158, 11, 0);
        }
      }

      /* Modern colorful badge styles */
      .badge-pending {
        background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
        color: #92400e;
        font-weight: 700;
        text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        box-shadow: 0 2px 8px rgba(245, 158, 11, 0.3);
        min-width: 1.5rem;
        aspect-ratio: 1;
      }

      .badge-success {
        background: linear-gradient(135deg, #34d399 0%, #10b981 100%);
        color: #064e3b;
        font-weight: 700;
        text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        box-shadow: 0 2px 8px rgba(16, 185, 129, 0.3);
        min-width: 1.5rem;
        aspect-ratio: 1;
      }

      .badge-error {
        background: linear-gradient(135deg, #f87171 0%, #ef4444 100%);
        color: #7f1d1d;
        font-weight: 700;
        text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        box-shadow: 0 2px 8px rgba(239, 68, 68, 0.3);
        min-width: 1.5rem;
        aspect-ratio: 1;
      }

      /* Badge hover effects */
      .badge-pending:hover {
        transform: scale(1.1);
        box-shadow: 0 4px 12px rgba(245, 158, 11, 0.4);
      }

      .badge-success:hover {
        transform: scale(1.1);
        box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
      }

      .badge-error:hover {
        transform: scale(1.1);
        box-shadow: 0 4px 12px rgba(239, 68, 68, 0.4);
      }
      .w-3 {
        width: 0.75rem;
      }
      .h-3 {
        height: 0.75rem;
      }
      .w-4 {
        width: 1rem;
      }
      .h-4 {
        height: 1rem;
      }
      .w-6 {
        width: 1.5rem;
      }
      .h-6 {
        height: 1.5rem;
      }
      .w-8 {
        width: 2rem;
      }
      .h-8 {
        height: 2rem;
      }
      .z-10 {
        z-index: 10;
      }
      .z-50 {
        z-index: 50;
      }

      /* Responsive dropdown positioning */
      @media (max-width: 640px) {
        #tasks-dropdown {
          right: 0;
          left: auto;
          width: 95vw;
          max-width: 20rem;
        }
      }

      /* Ensure dropdown is properly positioned and doesn't cause layout shifts */
      .dropdown-container {
        position: relative;
      }

      #tasks-dropdown {
        position: fixed;
        top: auto;
        right: 1rem;
        margin-top: 0.5rem;
        width: 22rem;
        z-index: 9999;
        transform: translateY(0);
        transition: all 0.3s ease;
      }

      /* Enhanced dropdown styles */
      .dropdown-header {
        background: linear-gradient(
          135deg,
          rgba(59, 130, 246, 0.03) 0%,
          rgba(99, 102, 241, 0.03) 100%
        );
        border-bottom: 1px solid rgba(59, 130, 246, 0.1);
        transition: all 0.6s ease;
      }

      .dark .dropdown-header {
        background: linear-gradient(
          135deg,
          rgba(59, 130, 246, 0.05) 0%,
          rgba(99, 102, 241, 0.05) 100%
        );
        border-bottom: 1px solid rgba(59, 130, 246, 0.15);
      }

      /* Enhanced tasks dropdown with colorful styling */
      #tasks-dropdown {
        position: relative;
        background: linear-gradient(
          135deg,
          rgba(255, 255, 255, 0.95) 0%,
          rgba(249, 250, 251, 0.95) 100%
        );
        border: 2px solid transparent;
        background-clip: padding-box;
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25),
          0 0 0 1px rgba(59, 130, 246, 0.1),
          inset 0 1px 0 rgba(255, 255, 255, 0.1);
      }

      .dark #tasks-dropdown {
        background: linear-gradient(
          135deg,
          rgba(31, 41, 55, 0.95) 0%,
          rgba(17, 24, 39, 0.95) 100%
        );
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5),
          0 0 0 1px rgba(59, 130, 246, 0.2),
          inset 0 1px 0 rgba(255, 255, 255, 0.05);
      }

      /* Add subtle glow effect */
      #tasks-dropdown::before {
        content: "";
        position: absolute;
        top: -3px;
        left: -3px;
        right: -3px;
        bottom: -3px;
        background: linear-gradient(
          45deg,
          #1e40af,
          #6d28d9,
          #be185d,
          #047857,
          #b45309,
          #1e40af
        );
        background-size: 300% 300%;
        border-radius: inherit;
        z-index: -1;
        opacity: 0.2;
        filter: blur(16px);
        transition: all 0.8s ease;
        animation: rainbow-glow 8s ease-in-out infinite;
      }

      @keyframes rainbow-glow {
        0%,
        100% {
          background-position: 0% 50%;
        }
        50% {
          background-position: 100% 50%;
        }
      }

      #tasks-dropdown:hover::before {
        opacity: 0.3;
        filter: blur(20px);
      }

      .dark #tasks-dropdown::before {
        opacity: 0.15;
      }

      .dark #tasks-dropdown:hover::before {
        opacity: 0.25;
      }

      .task-item {
        transition: all 0.6s cubic-bezier(0.4, 0, 0.2, 1);
        border-left: 3px solid transparent;
      }

      .task-item:hover {
        background: linear-gradient(
          135deg,
          rgba(59, 130, 246, 0.01) 0%,
          rgba(99, 102, 241, 0.01) 100%
        );
        border-left-color: rgba(59, 130, 246, 0.15);
        transform: translateX(2px);
      }

      .dark .task-item:hover {
        background: linear-gradient(
          135deg,
          rgba(59, 130, 246, 0.02) 0%,
          rgba(99, 102, 241, 0.02) 100%
        );
      }

      /* Enhanced download button - pill-shaped to match design system */
      .download-button {
        background: linear-gradient(135deg, #059669 0%, #047857 100%);
        border: none;
        color: white;
        border-radius: 9999px;
        padding: 0.5rem 1rem;
        font-weight: 500;
        font-size: 0.75rem;
        transition: all 0.6s cubic-bezier(0.4, 0, 0.2, 1);
        box-shadow: 0 2px 8px 0 rgba(16, 185, 129, 0.1);
        cursor: pointer;
        min-width: 70px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        text-decoration: none;
      }

      .download-button:hover {
        background: linear-gradient(135deg, #047857 0%, #065f46 100%);
        transform: translateY(-1px);
        box-shadow: 0 4px 12px 0 rgba(16, 185, 129, 0.15);
      }

      .download-button:active {
        transform: translateY(0);
        box-shadow: 0 2px 8px 0 rgba(16, 185, 129, 0.1);
      }

      .dark .download-button {
        background: linear-gradient(135deg, #047857 0%, #065f46 100%);
        box-shadow: 0 2px 8px 0 rgba(6, 95, 70, 0.15);
      }

      .dark .download-button:hover {
        background: linear-gradient(135deg, #065f46 0%, #064e3b 100%);
        box-shadow: 0 4px 12px 0 rgba(6, 95, 70, 0.2);
      }

      /* Remove default list bullets from tasks dropdown */
      #tasks-list {
        list-style: none;
        margin: 0;
        padding: 0;
      }

      #tasks-list li {
        list-style: none;
        list-style-type: none;
      }

      #tasks-list li::before {
        content: none;
      }

      /* Empty state styling */
      .empty-state {
        list-style: none !important;
        list-style-type: none !important;
      }

      .empty-state::before {
        content: none !important;
      }

      /* Task items should not have list styling */
      .task-item {
        list-style: none !important;
        list-style-type: none !important;
      }

      .task-item::before {
        content: none !important;
      }

      /* Task status indicators with enhanced styling */
      .status-indicator {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        position: relative;
        overflow: hidden;
        transition: all 0.8s ease;
      }

      .status-indicator.pending {
        background: linear-gradient(135deg, #d97706 0%, #b45309 100%);
        animation: pulse-glow 4s ease-in-out infinite;
      }

      .status-indicator.success {
        background: linear-gradient(135deg, #059669 0%, #047857 100%);
        box-shadow: 0 0 4px rgba(16, 185, 129, 0.2);
      }

      .status-indicator.failure {
        background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
        box-shadow: 0 0 4px rgba(239, 68, 68, 0.2);
      }

      @keyframes pulse-glow {
        0%,
        100% {
          box-shadow: 0 0 4px rgba(217, 119, 6, 0.3);
          transform: scale(1);
        }
        50% {
          box-shadow: 0 0 8px rgba(217, 119, 6, 0.4);
          transform: scale(1.05);
        }
      }

      /* Custom scrollbar for tasks list */
      #tasks-list::-webkit-scrollbar {
        width: 4px;
      }

      #tasks-list::-webkit-scrollbar-track {
        background: rgba(156, 163, 175, 0.1);
        border-radius: 2px;
      }

      #tasks-list::-webkit-scrollbar-thumb {
        background: linear-gradient(135deg, #d1d5db, #9ca3af);
        border-radius: 2px;
      }

      .dark #tasks-list::-webkit-scrollbar-thumb {
        background: linear-gradient(135deg, #4b5563, #374151);
      }

      /* Empty state styling */
      .empty-state {
        padding: 2rem 1rem;
        text-align: center;
        color: #6b7280;
      }

      .dark .empty-state {
        color: #9ca3af;
      }

      .empty-state svg {
        margin: 0 auto 0.75rem auto;
        opacity: 0.5;
      }

      /* Task item separator line */
      .task-separator {
        height: 1px;
        background: linear-gradient(
          90deg,
          transparent 0%,
          rgba(229, 231, 235, 0.6) 50%,
          transparent 100%
        );
        margin: 0 1rem;
      }

      .dark .task-separator {
        background: linear-gradient(
          90deg,
          transparent 0%,
          rgba(75, 85, 99, 0.6) 50%,
          transparent 100%
        );
      }

      /* Additional Tailwind classes */
      .mr-2 {
        margin-right: 0.5rem;
      }
      .mb-1 {
        margin-bottom: 0.25rem;
      }
      .mb-3 {
        margin-bottom: 0.75rem;
      }
      .mb-6 {
        margin-bottom: 1.5rem;
      }
      .mt-1 {
        margin-top: 0.25rem;
      }
      .mt-2 {
        margin-top: 0.5rem;
      }
      .px-3 {
        padding-left: 0.75rem;
        padding-right: 0.75rem;
      }
      .px-4 {
        padding-left: 1rem;
        padding-right: 1rem;
      }
      .px-6 {
        padding-left: 1.5rem;
        padding-right: 1.5rem;
      }
      .py-2 {
        padding-top: 0.5rem;
        padding-bottom: 0.5rem;
      }
      .py-3 {
        padding-top: 0.75rem;
        padding-bottom: 0.75rem;
      }
      .py-6 {
        padding-top: 1.5rem;
        padding-bottom: 1.5rem;
      }
      .py-12 {
        padding-top: 3rem;
        padding-bottom: 3rem;
      }
      .p-2 {
        padding: 0.5rem;
      }
      .p-6 {
        padding: 1.5rem;
      }
      .space-x-2 > :not([hidden]) ~ :not([hidden]) {
        --tw-space-x-reverse: 0;
        margin-right: calc(0.5rem * var(--tw-space-x-reverse));
        margin-left: calc(0.5rem * calc(1 - var(--tw-space-x-reverse)));
      }
      .space-x-3 > :not([hidden]) ~ :not([hidden]) {
        --tw-space-x-reverse: 0;
        margin-right: calc(0.75rem * var(--tw-space-x-reverse));
        margin-left: calc(0.75rem * calc(1 - var(--tw-space-x-reverse)));
      }
      .space-x-4 > :not([hidden]) ~ :not([hidden]) {
        --tw-space-x-reverse: 0;
        margin-right: calc(1rem * var(--tw-space-x-reverse));
        margin-left: calc(1rem * calc(1 - var(--tw-space-x-reverse)));
      }
      .space-y-3 > :not([hidden]) ~ :not([hidden]) {
        --tw-space-y-reverse: 0;
        margin-top: calc(0.75rem * calc(1 - var(--tw-space-y-reverse)));
        margin-bottom: calc(0.75rem * var(--tw-space-y-reverse));
      }
      .space-y-6 > :not([hidden]) ~ :not([hidden]) {
        --tw-space-y-reverse: 0;
        margin-top: calc(1.5rem * calc(1 - var(--tw-space-y-reverse)));
        margin-bottom: calc(1.5rem * var(--tw-space-y-reverse));
      }

      /* Animation classes */
      .animate-bounce {
        animation: bounce 1s infinite;
      }
      .animate-pulse {
        animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
      }

      @keyframes bounce {
        0%,
        100% {
          transform: translateY(-25%);
          animation-timing-function: cubic-bezier(0.8, 0, 1, 1);
        }
        50% {
          transform: none;
          animation-timing-function: cubic-bezier(0, 0, 0.2, 1);
        }
      }

      @keyframes pulse {
        50% {
          opacity: 0.5;
        }
      }

      /* Additional utility classes */
      .truncate {
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
      }
      .min-w-0 {
        min-width: 0px;
      }
      .flex-shrink-0 {
        flex-shrink: 0;
      }
      .last\:border-b-0:last-child {
        border-bottom-width: 0px;
      }
      .border-b {
        border-bottom-width: 1px;
      }
      .bg-yellow-400 {
        background-color: rgb(250 204 21);
      }
      .bg-green-400 {
        background-color: rgb(74 222 128);
      }
      .bg-red-400 {
        background-color: rgb(248 113 113);
      }
      .bg-gray-400 {
        background-color: rgb(156 163 175);
      }
      .text-yellow-600 {
        color: rgb(202 138 4);
      }
      .text-green-600 {
        color: rgb(22 163 74);
      }
      .text-red-600 {
        color: rgb(220 38 38);
      }
      .text-blue-500 {
        color: rgb(59 130 246);
      }
      .text-blue-700 {
        color: rgb(29 78 216);
      }
      .hover\:text-blue-700:hover {
        color: rgb(29 78 216);
      }
      .rounded-full {
        border-radius: 9999px;
      }
      .border-gray-100 {
        border-color: rgb(243 244 246);
      }
      .dark .border-gray-700 {
        border-color: rgb(55 65 81);
      }
      .border-blue-400 {
        border-color: rgb(96 165 250);
      }
      .bg-blue-50 {
        background-color: rgb(239 246 255);
      }
      .dark .bg-blue-900\/20 {
        background-color: rgb(30 58 138 / 0.2);
      }

      /* Main content container optimization */
      main {
        padding-left: 10vw;
        padding-right: 10vw;
      }

      @media (min-width: 1024px) {
        main {
          padding-left: 15vw;
          padding-right: 15vw;
        }
      }

      @media (min-width: 1280px) {
        main {
          padding-left: 20vw;
          padding-right: 20vw;
        }
      }

      /* Ensure tasks dropdown stands out with colorful styling */
    </style>
  </head>
  <body
    class="bg-gradient-to-br from-slate-50 via-blue-50 to-indigo-50 dark:from-gray-900 dark:via-gray-800 dark:to-slate-900 text-gray-800 dark:text-gray-100 antialiased min-h-screen font-light transition-colors duration-300"
  >
    <header
      class="relative z-20 backdrop-blur-sm bg-white/80 dark:bg-gray-900/90 border-b border-gray-200/50 dark:border-gray-700/60 py-6 px-6 transition-colors duration-300"
    >
      <div class="max-w-7xl mx-auto flex justify-between items-center">
        <div class="flex items-center space-x-4">
          <div
            class="w-6 h-6 bg-gradient-to-br from-purple-500 to-pink-500 rounded-lg icon-container"
          >
            <svg
              class="w-3 h-3 text-white"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"
              ></path>
            </svg>
          </div>
          <div>
            <h1
              class="text-2xl font-bold bg-gradient-to-r from-purple-600 to-pink-600 dark:from-purple-400 dark:to-pink-400 bg-clip-text text-transparent"
            >
              Document Extractor
            </h1>
            <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">
              AI-powered document analysis
            </p>
          </div>
        </div>
        <div class="flex items-center space-x-4">
          <button id="theme-toggle" class="theme-toggle-button">
            <!-- Icon will be dynamically inserted by JavaScript -->
          </button>
          <div class="dropdown-container">
            <button
              id="tasks-dropdown-button"
              class="tasks-button inline-flex items-center justify-center space-x-2 min-w-0"
            >
              <svg
                class="w-4 h-4 text-white flex-shrink-0"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"
                ></path>
              </svg>
              <span class="text-white font-semibold">Tasks</span>
            </button>
            <div
              id="tasks-dropdown"
              class="hidden rounded-2xl shadow-2xl z-50 backdrop-blur-xl max-h-96 overflow-hidden"
              style="max-width: 90vw"
            >
              <div class="dropdown-header p-4">
                <h3
                  class="text-sm font-semibold text-gray-900 dark:text-gray-100 flex items-center"
                >
                  <svg
                    class="w-4 h-4 mr-2 text-blue-500"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"
                    ></path>
                  </svg>
                  Recent Tasks
                </h3>
              </div>
              <ul id="tasks-list" class="py-2 max-h-64 overflow-y-auto">
                <li class="empty-state">
                  <svg
                    class="w-8 h-8"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="1.5"
                      d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"
                    ></path>
                  </svg>
                  <p class="text-sm font-medium">No tasks running</p>
                  <p class="text-xs mt-1 opacity-75">
                    Upload a file to start processing
                  </p>
                </li>
              </ul>
            </div>
          </div>
        </div>
      </div>
    </header>
    <main
      class="relative z-10 flex-1 flex items-center justify-center px-4 py-12 transition-colors duration-300"
    >
      <div
        class="w-full max-w-lg md:max-w-xl lg:max-w-2xl xl:max-w-3xl 2xl:max-w-4xl mx-auto"
      >
        <div
          class="glass p-8 lg:p-10 xl:p-12 rounded-2xl shadow-2xl border border-gray-200/50 dark:border-gray-700/50 backdrop-blur-xl"
        >
          <div class="text-center mb-8 lg:mb-10">
            <div
              class="w-8 h-8 lg:w-10 lg:h-10 bg-gradient-to-br from-purple-500 to-pink-500 rounded-lg icon-container mx-auto mb-4"
            >
              <svg
                class="w-4 h-4 lg:w-5 lg:h-5 text-white"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M7 16a4 4 0 01-.88-7.903A5 5 0 0115.9 6L16 6a3 3 0 013 3v10a2 2 0 01-2 2H7a2 2 0 01-2-2V16m-2-6l4-4m0 0l4 4m-4-4v12"
                ></path>
              </svg>
            </div>
            <h2
              class="text-2xl lg:text-3xl font-bold text-gray-900 dark:text-white mb-2"
            >
              Upload Document
            </h2>
            <p
              class="text-gray-600 dark:text-gray-400 font-light text-base lg:text-lg"
            >
              Extract text and tables with AI precision
            </p>
          </div>
          <form id="upload-form" class="space-y-8 lg:space-y-10">
            <div
              id="drop-area"
              class="drop-area border-2 border-dashed border-gray-300 dark:border-gray-600 rounded-2xl p-10 lg:p-12 xl:p-16 text-center cursor-pointer transition-all duration-300 hover:border-purple-400 hover:bg-purple-50 dark:hover:bg-purple-900/10"
            >
              <input
                type="file"
                name="file"
                id="file-input"
                class="hidden"
                accept="application/pdf,image/*"
              />
              <div class="space-y-4 lg:space-y-6">
                <div
                  class="w-12 h-12 lg:w-16 lg:h-16 bg-gradient-to-br from-blue-100 to-purple-100 dark:from-blue-900/30 dark:to-purple-900/30 rounded-lg icon-container mx-auto"
                >
                  <svg
                    class="w-6 h-6 lg:w-8 lg:h-8 text-blue-500 dark:text-blue-400"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M12 6v6m0 0v6m0-6h6m-6 0H6"
                    ></path>
                  </svg>
                </div>
                <div>
                  <p
                    class="text-lg lg:text-xl font-medium text-gray-700 dark:text-gray-300 mb-2"
                  >
                    Drop your files here
                  </p>
                  <p
                    class="text-base lg:text-lg text-gray-500 dark:text-gray-400"
                  >
                    or
                    <span class="text-blue-500 dark:text-blue-400 font-medium"
                      >click to browse</span
                    >
                  </p>
                  <p
                    class="text-sm lg:text-base text-gray-400 dark:text-gray-500 mt-2"
                  >
                    Support for PDF, PNG, JPG files
                  </p>
                </div>
              </div>
            </div>
            <button
              type="submit"
              id="upload-button"
              class="upload-button flex items-center justify-center space-x-2"
            >
              <span id="upload-text">Start Processing</span>
            </button>
          </form>
        </div>
      </div>
    </main>
    <script>
      // Basic functionality
      const dropArea = document.getElementById("drop-area");
      const fileInput = document.getElementById("file-input");
      const uploadForm = document.getElementById("upload-form");
      const uploadButton = document.getElementById("upload-button");
      const uploadText = document.getElementById("upload-text");

      // Tasks functionality
      const tasksDropdownButton = document.getElementById(
        "tasks-dropdown-button"
      );
      const tasksDropdown = document.getElementById("tasks-dropdown");
      const tasksList = document.getElementById("tasks-list");

      let tasks = new Map();
      let tasksInterval;

      // Initialize dropdown position on page load
      function initializeDropdownPosition() {
        const dropdown = tasksDropdown;
        const buttonRect = tasksDropdownButton.getBoundingClientRect();
        const viewportWidth = window.innerWidth;
        const dropdownWidth = 22 * 16; // 22rem in pixels

        // Set initial position below button (hidden)
        dropdown.style.position = "fixed";
        dropdown.style.top = buttonRect.bottom + 8 + "px";

        // Smart positioning to stay within viewport
        if (buttonRect.right - dropdownWidth < 16) {
          // Not enough space on the right, position from left
          dropdown.style.left = "1rem";
          dropdown.style.right = "1rem";
          dropdown.style.width = "auto";
          dropdown.style.maxWidth = "calc(100vw - 2rem)";
        } else {
          // Enough space, position normally
          dropdown.style.right = viewportWidth - buttonRect.right + "px";
          dropdown.style.left = "auto";
          dropdown.style.width = "22rem";
          dropdown.style.maxWidth = "22rem";
        }
      }

      // Initialize position after a short delay to ensure button is positioned
      setTimeout(initializeDropdownPosition, 100);

      dropArea.addEventListener("click", () => fileInput.click());

      // Enhanced drag and drop functionality
      dropArea.addEventListener("dragover", (e) => {
        e.preventDefault();
        dropArea.classList.add("drag-over");
      });

      dropArea.addEventListener("dragleave", (e) => {
        e.preventDefault();
        // Only remove class if we're actually leaving the drop area
        if (!dropArea.contains(e.relatedTarget)) {
          dropArea.classList.remove("drag-over");
        }
      });

      dropArea.addEventListener("drop", (e) => {
        e.preventDefault();
        dropArea.classList.remove("drag-over");

        const files = e.dataTransfer.files;
        if (files.length > 0) {
          fileInput.files = files;
          // Trigger upload automatically
          uploadForm.dispatchEvent(new Event("submit"));
        }
      });

      // Tasks dropdown toggle with proper positioning
      tasksDropdownButton.addEventListener("click", (e) => {
        e.stopPropagation();

        const dropdown = tasksDropdown;
        const isHidden = dropdown.classList.contains("hidden");

        if (isHidden) {
          // Position dropdown relative to button before showing
          const buttonRect = tasksDropdownButton.getBoundingClientRect();
          const viewportWidth = window.innerWidth;
          const dropdownWidth = 22 * 16; // 22rem in pixels

          // Always position below the button
          dropdown.style.position = "fixed";
          dropdown.style.top = buttonRect.bottom + 8 + "px";

          // Smart positioning to stay within viewport
          if (buttonRect.right - dropdownWidth < 16) {
            // Not enough space on the right, position from left
            dropdown.style.left = "1rem";
            dropdown.style.right = "1rem";
            dropdown.style.width = "auto";
            dropdown.style.maxWidth = "calc(100vw - 2rem)";
          } else {
            // Enough space, position normally
            dropdown.style.right = viewportWidth - buttonRect.right + "px";
            dropdown.style.left = "auto";
            dropdown.style.width = "22rem";
            dropdown.style.maxWidth = "22rem";
          }
        }

        dropdown.classList.toggle("hidden");
      });

      // Close dropdown when clicking outside
      document.addEventListener("click", (e) => {
        if (
          !tasksDropdownButton.contains(e.target) &&
          !tasksDropdown.contains(e.target)
        ) {
          tasksDropdown.classList.add("hidden");
        }
      });

      // File upload handling
      uploadForm.addEventListener("submit", async (e) => {
        e.preventDefault();

        const file = fileInput.files[0];
        if (!file) {
          alert("Please select a file to upload.");
          return;
        }

        const formData = new FormData();
        formData.append("file", file);

        // Update UI to show loading state
        uploadButton.disabled = true;
        uploadText.textContent = "Processing...";
        uploadButton.classList.add("opacity-75");

        try {
          const response = await fetch("/uploadfile/", {
            method: "POST",
            body: formData,
          });

          const result = await response.json();

          if (response.ok) {
            // Add task to local tracking
            tasks.set(result.task_id, {
              id: result.task_id,
              status: "PENDING",
              filename: file.name,
              timestamp: new Date(),
            });

            // Save to localStorage
            saveTasksToLocalStorage();

            // Update tasks display
            updateTasksDisplay();

            // Add bounce animation to tasks button
            tasksDropdownButton.classList.add("animate-bounce");
            setTimeout(() => {
              tasksDropdownButton.classList.remove("animate-bounce");
            }, 1000);

            // Start polling for updates
            if (!tasksInterval) {
              startTasksPolling();
            }

            // Reset form
            fileInput.value = "";
            uploadText.textContent = "File uploaded! Check tasks for progress.";

            setTimeout(() => {
              uploadText.textContent = "Start Processing";
              uploadButton.classList.remove("opacity-75");
              uploadButton.disabled = false;
            }, 2000);
          } else {
            throw new Error(result.detail || "Upload failed");
          }
        } catch (error) {
          console.error("Upload error:", error);
          alert("Error uploading file: " + error.message);
          uploadText.textContent = "Start Processing";
          uploadButton.classList.remove("opacity-75");
          uploadButton.disabled = false;
        }
      });

      // Update tasks button with vibrant colorful badges and counters
      function updateTasksButton() {
        const pendingCount = Array.from(tasks.values()).filter((task) =>
          ["PENDING", "STARTED", "RETRY"].includes(task.status)
        ).length;

        const successCount = Array.from(tasks.values()).filter(
          (task) => task.status === "SUCCESS"
        ).length;

        const errorCount = Array.from(tasks.values()).filter(
          (task) => task.status === "FAILURE"
        ).length;

        // Create vibrant colorful badges HTML with animations
        let badgesHtml = "";
        if (pendingCount > 0) {
          badgesHtml += `<span class="badge-enter badge-pulse badge-pending inline-flex items-center justify-center w-6 h-6 rounded-full text-xs font-bold ml-2 transition-all duration-200 cursor-pointer leading-none">${pendingCount}</span>`;
        }
        if (successCount > 0) {
          badgesHtml += `<span class="badge-enter badge-success inline-flex items-center justify-center w-6 h-6 rounded-full text-xs font-bold ml-2 transition-all duration-200 cursor-pointer leading-none">${successCount}</span>`;
        }
        if (errorCount > 0) {
          badgesHtml += `<span class="badge-enter badge-error inline-flex items-center justify-center w-6 h-6 rounded-full text-xs font-bold ml-2 transition-all duration-200 cursor-pointer leading-none">${errorCount}</span>`;
        }

        tasksDropdownButton.innerHTML = `
          <svg class="w-4 h-4 text-white flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"></path>
          </svg>
          <span class="text-white font-semibold">Tasks</span>
          ${badgesHtml}
        `;
      }

      // Update tasks display
      function updateTasksDisplay() {
        if (tasks.size === 0) {
          tasksList.innerHTML = `
            <li class="empty-state">
              <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"></path>
              </svg>
              <p class="text-sm font-medium">No tasks running</p>
              <p class="text-xs mt-1 opacity-75">Upload a file to start processing</p>
            </li>
          `;
          updateTasksButton();
          return;
        }

        const sortedTasks = Array.from(tasks.values()).sort(
          (a, b) => b.timestamp - a.timestamp
        );

        tasksList.innerHTML = sortedTasks
          .map((task, index) => {
            const statusIcon = getStatusIcon(task.status);
            const statusColor = getStatusColor(task.status);
            const timeAgo = getTimeAgo(task.timestamp);
            const isLast = index === sortedTasks.length - 1;

            return `
            <li class="task-item px-4 py-4${
              !isLast
                ? " border-b border-gray-100/50 dark:border-gray-700/50"
                : ""
            }">
              <div class="flex items-center justify-between">
                <div class="flex items-center space-x-3 flex-1 min-w-0">
                  <div class="flex-shrink-0">
                    ${statusIcon}
                  </div>
                  <div class="flex-1 min-w-0">
                    <p class="text-sm font-medium text-gray-900 dark:text-gray-100 truncate">
                      ${task.filename}
                    </p>
                    <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">
                      ${timeAgo} • <span class="${statusColor} font-medium">${getStatusDisplayName(
              task.status
            )}</span>
                    </p>
                  </div>
                </div>
                ${
                  task.status === "SUCCESS"
                    ? `
                  <button onclick="downloadResult('${task.id}')" class="download-button flex items-center space-x-1">
                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                    </svg>
                    <span>Download</span>
                  </button>
                `
                    : ""
                }
              </div>
            </li>
          `;
          })
          .join("");

        updateTasksButton();
      }

      // Get status icon based on task status
      function getStatusIcon(status) {
        switch (status) {
          case "PENDING":
          case "STARTED":
          case "RETRY":
            return '<div class="status-indicator pending"></div>';
          case "SUCCESS":
            return '<div class="status-indicator success"></div>';
          case "FAILURE":
            return '<div class="status-indicator failure"></div>';
          default:
            return '<div class="status-indicator" style="background: #9ca3af;"></div>';
        }
      }

      // Get status color class
      function getStatusColor(status) {
        switch (status) {
          case "PENDING":
          case "STARTED":
          case "RETRY":
            return "text-amber-600 dark:text-amber-400";
          case "SUCCESS":
            return "text-emerald-600 dark:text-emerald-400";
          case "FAILURE":
            return "text-red-600 dark:text-red-400";
          default:
            return "text-gray-600 dark:text-gray-400";
        }
      }

      // Get human-readable status display name
      function getStatusDisplayName(status) {
        switch (status) {
          case "PENDING":
            return "Pending";
          case "STARTED":
            return "Processing";
          case "RETRY":
            return "Retrying";
          case "SUCCESS":
            return "Completed";
          case "FAILURE":
            return "Failed";
          default:
            return status;
        }
      }

      // Get time ago string
      function getTimeAgo(timestamp) {
        const now = new Date();
        const diff = now - timestamp;
        const minutes = Math.floor(diff / 60000);

        if (minutes < 1) return "Just now";
        if (minutes < 60) return `${minutes}m ago`;

        const hours = Math.floor(minutes / 60);
        if (hours < 24) return `${hours}h ago`;

        const days = Math.floor(hours / 24);
        return `${days}d ago`;
      }

      // Download result function
      window.downloadResult = function (taskId) {
        window.open(`/download_markdown/${taskId}`, "_blank");
      };

      // Fetch tasks from server with improved error handling
      async function fetchTasks() {
        try {
          const response = await fetch("/api/tasks");
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }

          const serverTasks = await response.json();
          console.log("Fetched tasks from server:", serverTasks.length);

          // Merge server tasks with local tasks
          const updatedTasks = new Map();

          // First, add all server tasks
          serverTasks.forEach((serverTask) => {
            const taskId = serverTask.task_id;
            updatedTasks.set(taskId, {
              id: taskId,
              status: serverTask.status,
              filename: serverTask.filename || "Unknown",
              timestamp: serverTask.timestamp
                ? new Date(serverTask.timestamp * 1000)
                : new Date(),
            });
          });

          // Then, add any local tasks that aren't on the server (recently uploaded)
          tasks.forEach((localTask, taskId) => {
            if (!updatedTasks.has(taskId)) {
              // Keep local task if it's not on server yet (might be very new)
              const taskAge = Date.now() - localTask.timestamp.getTime();
              if (taskAge < 60000) {
                // Keep tasks younger than 1 minute
                updatedTasks.set(taskId, localTask);
              }
            }
          });

          // Replace tasks map with updated version
          tasks.clear();
          updatedTasks.forEach((task, taskId) => {
            tasks.set(taskId, task);
          });

          // Save updated tasks to localStorage
          saveTasksToLocalStorage();

          // Update display
          updateTasksDisplay();

          // Auto-manage polling based on task states
          const hasActiveTasks = Array.from(tasks.values()).some((task) =>
            ["PENDING", "STARTED", "RETRY"].includes(task.status)
          );

          if (!hasActiveTasks && tasksInterval) {
            console.log("No active tasks, stopping polling");
            clearInterval(tasksInterval);
            tasksInterval = null;
          } else if (hasActiveTasks && !tasksInterval) {
            console.log("Active tasks found, starting polling");
            startTasksPolling();
          }
        } catch (error) {
          console.error("Error fetching tasks:", error);
          // Don't clear local tasks on fetch error, just log it
        }
      }

      // Start polling for task updates
      function startTasksPolling() {
        if (tasksInterval) {
          clearInterval(tasksInterval);
        }

        tasksInterval = setInterval(fetchTasks, 2000); // Poll every 2 seconds
      }

      // Enhanced localStorage functions for task persistence
      function saveTasksToLocalStorage() {
        try {
          const tasksArray = Array.from(tasks.entries()).map(([id, task]) => ({
            id,
            ...task,
            timestamp:
              task.timestamp instanceof Date
                ? task.timestamp.getTime()
                : task.timestamp,
          }));

          const dataToSave = {
            tasks: tasksArray,
            lastSaved: Date.now(),
            version: "1.0",
          };

          localStorage.setItem(
            "documentExtractorTasks",
            JSON.stringify(dataToSave)
          );
          console.log(`Saved ${tasksArray.length} tasks to localStorage`);
        } catch (error) {
          console.error("Error saving tasks to localStorage:", error);
        }
      }

      function loadTasksFromLocalStorage() {
        try {
          const saved = localStorage.getItem("documentExtractorTasks");
          if (saved) {
            const data = JSON.parse(saved);

            // Handle both old and new format
            const tasksArray = data.tasks || data; // data.tasks for new format, data for old format

            // Only load tasks that are less than 24 hours old
            const maxAge = 24 * 60 * 60 * 1000; // 24 hours
            const now = Date.now();

            let loadedCount = 0;
            tasksArray.forEach((taskData) => {
              const taskAge = now - taskData.timestamp;
              if (taskAge < maxAge) {
                tasks.set(taskData.id, {
                  id: taskData.id,
                  status: taskData.status,
                  filename: taskData.filename,
                  timestamp: new Date(taskData.timestamp),
                });
                loadedCount++;
              }
            });

            console.log(`Loaded ${loadedCount} tasks from localStorage`);
          }
        } catch (error) {
          console.error("Error loading tasks from localStorage:", error);
          // Clear corrupted data
          localStorage.removeItem("documentExtractorTasks");
        }
      }

      // Clean up old completed tasks (keep only last 10)
      function cleanupOldTasks() {
        const completedTasks = Array.from(tasks.values())
          .filter((task) => ["SUCCESS", "FAILURE"].includes(task.status))
          .sort((a, b) => b.timestamp - a.timestamp);

        if (completedTasks.length > 10) {
          const tasksToRemove = completedTasks.slice(10);
          tasksToRemove.forEach((task) => tasks.delete(task.id));
          saveTasksToLocalStorage();
        }
      }

      // Enhanced theme toggle with system preference detection
      const themeToggle = document.getElementById("theme-toggle");
      const htmlElement = document.documentElement;

      // Function to get system theme preference
      function getSystemTheme() {
        return window.matchMedia &&
          window.matchMedia("(prefers-color-scheme: dark)").matches
          ? "dark"
          : "light";
      }

      // Get current theme - priority: localStorage > system preference > default light
      function getCurrentTheme() {
        const storedTheme = localStorage.getItem("theme");
        if (
          storedTheme &&
          (storedTheme === "dark" || storedTheme === "light")
        ) {
          return storedTheme;
        }
        return getSystemTheme();
      }

      const currentTheme = getCurrentTheme();

      // Create and manage theme icons dynamically
      function createThemeIcon(theme) {
        if (theme === "dark") {
          // Show sun icon when in dark mode (to switch to light)
          return `
            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 6.464A1 1 0 106.465 5.05l-.708-.707a1 1 0 00-1.414 1.414l.707.707zm1.414 8.486l-.707.707a1 1 0 01-1.414-1.414l.707-.707a1 1 0 011.414 1.414zM4 11a1 1 0 100-2H3a1 1 0 000 2h1z" clip-rule="evenodd"></path>
            </svg>
          `;
        } else {
          // Show moon icon when in light mode (to switch to dark)
          return `
            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
              <path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"></path>
            </svg>
          `;
        }
      }

      function updateTheme(theme) {
        if (theme === "dark") {
          htmlElement.classList.add("dark");
          // Show sun icon when in dark mode (to switch to light)
          themeToggle.innerHTML = createThemeIcon("dark");
        } else {
          htmlElement.classList.remove("dark");
          // Show moon icon when in light mode (to switch to dark)
          themeToggle.innerHTML = createThemeIcon("light");
        }
        // Only save to localStorage when user manually changes theme
        if (arguments.length > 1 && arguments[1] === true) {
          localStorage.setItem("theme", theme);
        }
      }

      updateTheme(currentTheme); // Don't save on initial load

      themeToggle.addEventListener("click", () => {
        const isDark = htmlElement.classList.contains("dark");
        const newTheme = isDark ? "light" : "dark";
        updateTheme(newTheme, true); // Pass true to save preference
      });

      // Listen for system theme changes
      if (window.matchMedia) {
        const mediaQuery = window.matchMedia("(prefers-color-scheme: dark)");
        mediaQuery.addEventListener("change", (e) => {
          // Only update if user hasn't manually set a preference
          const hasManualPreference = localStorage.getItem("theme");
          if (!hasManualPreference) {
            const systemTheme = e.matches ? "dark" : "light";
            updateTheme(systemTheme);
          }
        });
      }

      // Initialize tasks display
      updateTasksDisplay();

      // Enhanced app initialization with better debugging
      async function initializeApp() {
        console.log("Initializing Document Extractor app...");

        // Load tasks from localStorage first
        loadTasksFromLocalStorage();
        console.log(`Initial tasks from localStorage: ${tasks.size}`);

        // Update display with local tasks
        updateTasksDisplay();

        // Then fetch latest from server (this will merge and update)
        console.log("Fetching tasks from server...");
        await fetchTasks();

        // Clean up old tasks
        cleanupOldTasks();

        // Start polling if we have active tasks
        const activeTasks = Array.from(tasks.values()).filter((task) =>
          ["PENDING", "STARTED", "RETRY"].includes(task.status)
        );

        console.log(`Active tasks found: ${activeTasks.length}`);

        if (activeTasks.length > 0) {
          console.log("Starting polling for active tasks");
          startTasksPolling();
        }

        console.log("App initialization complete");
      }

      // Initialize the app
      initializeApp();
    </script>
  </body>
</html>
